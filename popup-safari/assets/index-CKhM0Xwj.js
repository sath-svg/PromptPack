import{a as vt,l as A,r as pt,b as bt,c as kt,T as Pt,g as $t,d as St,e as At,f as xt,u as Et,h as rt,i as Dt,j as Tt,k as Nt}from"./theme-CHys-yvq.js";import{g as Rt,v as Ct,a as Q,l as It,b as Ot}from"./auth-BzzJO1E-.js";import{M as U,P as dt,a as T,i as F,D as Lt,b as Ut,c as _t,T as Ht,d as at,F as Mt}from"./api-lEPXQ6QH.js";const et="AES-GCM",Bt=256,X=12,C=16,Ft=1e5,Gt=32,z=1,M="1.0",I=new Uint8Array([80,80,75,0]),_=new Uint8Array([80,80,75,1]),S=I.length+1+Gt,ot=new Uint8Array([80,114,111,109,112,116,80,97,99,107]);class D extends Error{constructor(e,n){super(e),this.name="PmtpkError",this.code=n}}async function q(t){const e=await crypto.subtle.digest("SHA-256",new Uint8Array(t));return new Uint8Array(e)}function lt(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}async function ut(t){const r=new Blob([new Uint8Array(t)]).stream().pipeThrough(new CompressionStream("gzip")).getReader(),a=[];for(;;){const{done:i,value:p}=await r.read();if(i)break;a.push(p)}const d=a.reduce((i,p)=>i+p.length,0),o=new Uint8Array(d);let s=0;for(const i of a)o.set(i,s),s+=i.length;return o}async function mt(t){const r=new Blob([new Uint8Array(t)]).stream().pipeThrough(new DecompressionStream("gzip")).getReader(),a=[];for(;;){const{done:i,value:p}=await r.read();if(i)break;a.push(p)}const d=a.reduce((i,p)=>i+p.length,0),o=new Uint8Array(d);let s=0;for(const i of a)o.set(i,s),s+=i.length;return o}function ht(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t[n]^ot[n%ot.length];return e}async function B(t){const n=new TextEncoder().encode(t),r=await q(n),a=await ut(n),d=ht(a),o=new Uint8Array(S+d.length);return o.set(I,0),o[I.length]=z,o.set(r,I.length+1),o.set(d,S),o}async function jt(t){if(t.length<S)throw new D("File is too small or corrupted","CORRUPTED");const e=t[I.length];if(e>z)throw new D(`Unsupported format version ${e}. Please update PromptPack.`,"UNSUPPORTED_VERSION");const n=t.slice(I.length+1,S),r=t.slice(S),a=ht(r),d=await mt(a),o=await q(d);if(!lt(n,o))throw new D("File is corrupted (hash mismatch)","CORRUPTED");return new TextDecoder().decode(d)}function Kt(t){return t.length<4?!1:t[0]===80&&t[1]===80&&t[2]===75&&t[3]===0}function Vt(t){return t.length<4?!1:t[0]===80&&t[1]===80&&t[2]===75&&t[3]===1}async function ft(t,e){const n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(t),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:new Uint8Array(e),iterations:Ft,hash:"SHA-256"},r,{name:et,length:Bt},!1,["encrypt","decrypt"])}async function W(t,e){const n=new TextEncoder,r=crypto.getRandomValues(new Uint8Array(C)),a=crypto.getRandomValues(new Uint8Array(X)),d=n.encode(t),o=await q(d),s=await ut(d),i=await ft(e,r),p=await crypto.subtle.encrypt({name:et,iv:a},i,new Uint8Array(s)),m=S+C+X,u=new Uint8Array(m+p.byteLength);return u.set(_,0),u[_.length]=z,u.set(o,_.length+1),u.set(r,S),u.set(a,S+C),u.set(new Uint8Array(p),m),u}async function zt(t,e){const n=S+C+X;if(t.length<n)throw new D("File is too small or corrupted","CORRUPTED");const r=t[_.length];if(r>z)throw new D(`Unsupported format version ${r}. Please update PromptPack.`,"UNSUPPORTED_VERSION");const a=t.slice(_.length+1,S),d=t.slice(S,S+C),o=t.slice(S+C,n),s=t.slice(n),i=await ft(e,d);try{const p=await crypto.subtle.decrypt({name:et,iv:o},i,s),m=await mt(new Uint8Array(p)),u=await q(m);if(!lt(a,u))throw new D("File is corrupted (hash mismatch)","CORRUPTED");return new TextDecoder().decode(m)}catch(p){throw p instanceof D?p:new D("Wrong password","WRONG_PASSWORD")}}function qt(t){return t.billing?.isPro?at:t.entitlements?.promptLimit?t.entitlements.promptLimit:t.user?.tier==="paid"?at:Mt}const $={import:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',undo:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14L4 9l5-5"/><path d="M4 9h11a5 5 0 0 1 0 10H4"/></svg>',export:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',save:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',delete:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',edit:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>',chevron:'<svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor"><polygon points="2,0 10,5 2,10"/></svg>',user:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'};let w={isAuthenticated:!1},Z=!0;const Yt=30*1e3,G="pp_header_requeue_user";let nt=!1;const tt="pp_last_pro_status";async function Wt(){const e=(await chrome.storage.local.get(tt))[tt];return e===!0||e===!1?e:null}async function Jt(t){await chrome.storage.local.set({[tt]:t})}let O=null,j="",J=null;function x(){O=null}function Qt(t,e){if(!e.trim())return t;const n=e.toLowerCase();return t.filter(r=>r.text.toLowerCase().includes(n)||r.header&&r.header.toLowerCase().includes(n))}let L=null,R="";function Xt(){nt||(nt=!0,chrome.storage.onChanged.addListener((t,e)=>{e==="local"&&t[dt]&&(x(),g(!0))}))}async function K(){await bt({staleMs:Yt,max:5})>0&&await g(!0)}async function V(t){if(!t.isAuthenticated||!t.user?.id||(await chrome.storage.local.get(G))[G]===t.user.id)return;await chrome.storage.local.set({[G]:t.user.id}),await kt({max:5})>0&&await g(!0)}let N=[];async function Zt(){const t=N.pop();if(!t){c("Nothing to undo");return}if(t.type==="delete"||t.type==="delete-folder"){if(!(await Dt(t.prompts)).ok){c("Failed to restore prompts. Please try again."),N.push(t);return}x(),c(`Restored ${t.prompts.length} prompt${t.prompts.length!==1?"s":""}`)}else if(t.type==="import"){const e=t.prompts.map(r=>r.id);if(!(await pt(e)).ok){c("Failed to remove imported prompts. Please try again."),N.push(t);return}x(),c(`Removed ${t.prompts.length} imported prompt${t.prompts.length!==1?"s":""}`)}await g()}async function te(t){try{const e=await A(),r=new Set(e.filter(P=>P.packName).map(P=>`${P.source}:${P.packName}`)).size;if(r>=U){c(`Pack limit reached (${r}/${U}). Delete a pack to import new ones.`);return}const a=e.length,d=qt(w),o=await t.arrayBuffer(),s=new Uint8Array(o),i=Vt(s),p=Kt(s);let m;if(i){const P=prompt(`Enter password (letters and numbers only, max ${T} characters):`);if(!P){c("Import cancelled");return}if(!F(P)){c(`Password must be 1-${T} characters, letters and numbers only`);return}m=await zt(s,P)}else p?m=await jt(s):m=new TextDecoder().decode(s);const u=JSON.parse(m);if(!u.prompts||!Array.isArray(u.prompts)){c("Invalid .pmtpk file");return}const v=u.source||"chatgpt",f=u.title||t.name.replace(/\.pmtpk$/,""),b=u.prompts.length,y=a+b;if(y>d){c(`Cannot import: would exceed ${d} prompt limit (${a} + ${b} = ${y})`);return}await Tt(90)&&c("Warning: Storage is nearly full. Import may fail.");const l=u.prompts.map(P=>({text:P.text,source:v,url:P.url||"",...P.header&&{header:P.header},...P.headerGeneratedAt&&{headerGeneratedAt:P.headerGeneratedAt}})),E=await Nt(l,f);if(!E.ok){c(`Import failed: ${E.error||"Storage error"}. Please try again.`);return}x(),N.push({type:"import",prompts:E.imported}),c(`Imported ${E.imported.length} prompt${E.imported.length!==1?"s":""} from "${f}"`),await g()}catch(e){if(e instanceof D)switch(e.code){case"WRONG_PASSWORD":c("Wrong password");break;case"CORRUPTED":c("File is corrupted");break;case"UNSUPPORTED_VERSION":c("Please update PromptPack");break;case"INVALID_FORMAT":c("Invalid file format");break;default:c("Failed to import file")}else c("Failed to import file")}}function h(t){return t.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[e]??e)}function c(t){let e=document.getElementById("pp-popup-toast");e||(e=document.createElement("div"),e.id="pp-popup-toast",e.style.cssText=`
      position: fixed;
      left: 50%;
      bottom: 10px;
      transform: translateX(-50%);
      z-index: 999999;
      padding: 8px 10px;
      border-radius: 10px;
      background: var(--toast-bg);
      color: var(--toast-text);
      font-size: 12px;
      opacity: 0;
      transition: opacity 140ms ease;
      pointer-events: none;
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      font-family: "Open Sans", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    `,document.body.appendChild(e)),e.textContent=t,e.style.opacity="1",setTimeout(()=>e.style.opacity="0",Ht)}function ee(t){const e=[],n=new Map,r={chatgpt:[],claude:[],gemini:[],perplexity:[],grok:[],deepseek:[],kimi:[]};for(const i of t)if(i.packName){const p=`${i.source}:${i.packName}`;n.has(p)||n.set(p,[]),n.get(p).push(i)}else r[i.source]?.push(i);const a=Array.from(n.entries()).map(([i,p])=>{const[m,u]=i.split(":");return{type:"pack",key:i,displayName:u,source:m,prompts:p.sort((v,f)=>f.createdAt-v.createdAt),mostRecent:Math.max(...p.map(v=>v.createdAt))}}).sort((i,p)=>p.mostRecent-i.mostRecent);e.push(...a);const d=["chatgpt","claude","gemini"],o=["perplexity","grok","deepseek","kimi"],s=[...d,...o];for(const i of s){const p=r[i];e.push({type:"source",key:i,displayName:gt(i),source:i,prompts:p.sort((m,u)=>u.createdAt-m.createdAt)})}return e}function gt(t){return t==="chatgpt"?"ChatGPT":t==="claude"?"Claude":t==="gemini"?"Gemini":t==="perplexity"?"Perplexity":t==="grok"?"Grok":t==="deepseek"?"DeepSeek":t==="kimi"?"Kimi":t}const re=["perplexity","grok","deepseek","kimi"];function st(t){return re.includes(t)}function ae(t){const e=t.trim();return e.length>180||e.includes(`
`)}function oe(t){const e=t.text.trim(),n=e.replace(/\s+/g," ").trim(),r=n.length>160?n.slice(0,160)+"...":n,a=ae(e),d=L===t.id,o=d&&R||t.text,s=t.header?`<div class="pp-header-wrapper">
         <div class="pp-header-tag" data-prompt-id="${h(t.id)}">${h(t.header)}</div>
         <button class="pp-header-edit-btn" data-edit-header="${h(t.id)}" type="button" title="Edit header">âœŽ</button>
       </div>`:t.classifying?`<div class="pp-header-wrapper">
           <div class="pp-header-loading">
             <span class="pp-header-spinner"></span>
             <span class="pp-header-loading-text">Generating header...</span>
           </div>
         </div>`:`<div class="pp-header-wrapper">
           <button class="pp-add-header-btn" data-edit-header="${h(t.id)}" type="button">+ Add header</button>
         </div>`;return d?`
      <div class="pp-row">
        ${s}
        <div class="pp-edit">
          <textarea class="pp-edit-text" data-edit-input="${h(t.id)}">${h(o)}</textarea>
          <div class="pp-edit-actions">
            <button class="pp-btn" data-save-prompt="${h(t.id)}" type="button">Save</button>
            <button class="pp-btn" data-cancel-edit="${h(t.id)}" type="button">Cancel</button>
          </div>
        </div>
      </div>
    `:a?`
    <details class="pp-item" data-id="${h(t.id)}">
      <summary class="pp-item-sum">
        ${s}
        <div class="pp-item-content">
          <div class="pp-item-left">
            <span class="pp-item-arrow">${$.chevron}</span>
            <span class="pp-item-preview">${h(r)}</span>
          </div>
          <div class="pp-actions">
            <button class="pp-btn" data-copy="${h(t.id)}" type="button">Copy</button>
            <button class="pp-icon-btn" data-edit-prompt="${h(t.id)}" type="button" aria-label="Edit" title="Edit">${$.edit}</button>
            <button class="pp-icon-btn" data-del="${h(t.id)}" type="button" aria-label="Delete" title="Delete">${$.delete}</button>
          </div>
        </div>
      </summary>

      <div class="pp-item-body">
        <pre class="pp-full">${h(e)}</pre>
      </div>
    </details>
  `:`
      <div class="pp-row">
        ${s}
        <div class="pp-text" title="${h(e)}">${h(e)}</div>
        <div class="pp-actions">
          <button class="pp-btn" data-copy="${h(t.id)}" type="button">Copy</button>
          <button class="pp-icon-btn" data-edit-prompt="${h(t.id)}" type="button" aria-label="Edit" title="Edit">${$.edit}</button>
          <button class="pp-icon-btn" data-del="${h(t.id)}" type="button" aria-label="Delete" title="Delete">${$.delete}</button>
        </div>
      </div>
    `}let it=!1,ct=!1;function ne(){it||(it=!0,chrome.storage.onChanged.addListener(async(t,e)=>{if(e!=="local")return;const n=t[Pt];if(n){const a=n.newValue??$t();document.documentElement.dataset.theme=a,await g();return}if(t[dt]){x(),await g();return}}))}async function se(){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t?.url)return null;const e=t.url.toLowerCase();return e.includes("claude.ai")?"claude":e.includes("gemini.google.com")?"gemini":e.includes("chatgpt.com")||e.includes("chat.openai.com")?"chatgpt":e.includes("perplexity.ai")?"perplexity":e.includes("grok.com")||e.includes("x.com/i/grok")?"grok":e.includes("chat.deepseek.com")?"deepseek":e.includes("kimi.moonshot.cn")?"kimi":null}catch{return null}}function ie(){if(ct)return;ct=!0;const t=document.getElementById("app");t&&(t.addEventListener("click",async e=>{const r=e.target.closest("button");if(r){if(r.dataset.copy){e.preventDefault(),e.stopPropagation();const a=r.dataset.copy,o=(await A()).find(s=>s.id===a);if(!o)return;try{await navigator.clipboard.writeText(o.text),c("Copied")}catch{c("Copy failed")}return}if(r.dataset.del){e.preventDefault(),e.stopPropagation();const a=r.dataset.del,o=(await A()).find(s=>s.id===a);o&&N.push({type:"delete",prompts:[o]}),await St(a),x(),c("Deleted"),await g();return}if(r.dataset.deleteFolder){e.preventDefault(),e.stopPropagation();const a=r.dataset.deleteFolder,o=(await A()).filter(s=>s.source===a&&!s.packName);if(o.length===0){c("No prompts to delete");return}N.push({type:"delete-folder",prompts:o,source:a}),await At(a),x(),c(`Deleted ${o.length} prompt${o.length!==1?"s":""}`),await g();return}if(r.dataset.deletePack){e.preventDefault(),e.stopPropagation();const a=r.dataset.deletePack,[d,o]=a.split(":"),s=await xt(o,d);if(!s.ok){c(`Failed to delete pack: ${s.error||"Storage error"}`);return}if(s.deleted.length===0){c("No prompts to delete");return}N.push({type:"delete-folder",prompts:s.deleted,source:d}),x(),c(`Deleted "${o}" pack (${s.deleted.length} prompts)`),await g();return}if(r.dataset.editPrompt){e.preventDefault(),e.stopPropagation();const a=r.dataset.editPrompt,o=(await A()).find(s=>s.id===a);if(!o)return;L=a,R=o.text,await g();return}if(r.dataset.savePrompt){e.preventDefault(),e.stopPropagation();const a=r.dataset.savePrompt,d=R.trim();if(!d){c("Prompt cannot be empty");return}(await Et(a,d)).ok?(L=null,R="",x(),c("Prompt updated"),await g()):c("Failed to update prompt");return}if(r.dataset.cancelEdit){e.preventDefault(),e.stopPropagation(),L=null,R="",await g();return}if(r.dataset.editHeader){e.preventDefault(),e.stopPropagation();const a=r.dataset.editHeader,o=(await A()).find(u=>u.id===a);if(!o)return;const s=window.prompt("Edit header (1-2 words max):",o.header||"");if(s===null)return;const i=s.trim();if(i===""){(await rt(a,"")).ok?(x(),c("Header removed"),await g()):c("Failed to remove header");return}if(i.split(/\s+/).length>2){c("Header must be 1-2 words maximum");return}(await rt(a,i)).ok?(x(),c("Header updated"),await g()):c("Failed to update header");return}if(r.dataset.export){e.preventDefault(),e.stopPropagation();const a=r.dataset.export,o=(await A()).filter(y=>y.source===a&&!y.packName);if(o.length===0){c("No prompts to export");return}const s=prompt(`Enter a password to encrypt (letters/numbers only, max ${T} chars, or leave empty):`);if(s===null)return;if(s&&!F(s)){c(`Password must be 1-${T} characters, letters and numbers only`);return}const i=gt(a),p={version:M,source:a,title:i,exportedAt:new Date().toISOString(),prompts:o.map(y=>({text:y.text,url:y.url,createdAt:y.createdAt,...y.header&&{header:y.header},...y.headerGeneratedAt&&{headerGeneratedAt:y.headerGeneratedAt}}))},m=JSON.stringify(p);let u;s?u=await W(m,s):u=await B(m);const v=new Blob([new Uint8Array(u)],{type:"application/octet-stream"}),f=URL.createObjectURL(v),b=document.createElement("a");b.href=f,b.download=`${a}-prompts-${Date.now()}.pmtpk`,document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(f),c(`Exported ${o.length} prompt${o.length!==1?"s":""}${s?" (encrypted)":""}`);return}if(r.dataset.exportPack){e.preventDefault(),e.stopPropagation();const a=r.dataset.exportPack,[d,o]=a.split(":"),i=(await A()).filter(k=>k.packName===o&&k.source===d);if(i.length===0){c("No prompts to export");return}const p=prompt(`Enter a password to encrypt (letters/numbers only, max ${T} chars, or leave empty):`);if(p===null)return;if(p&&!F(p)){c(`Password must be 1-${T} characters, letters and numbers only`);return}const m={version:M,source:d,title:o,exportedAt:new Date().toISOString(),prompts:i.map(k=>({text:k.text,url:k.url,createdAt:k.createdAt,...k.header&&{header:k.header},...k.headerGeneratedAt&&{headerGeneratedAt:k.headerGeneratedAt}}))},u=JSON.stringify(m);let v;p?v=await W(u,p):v=await B(u);const f=new Blob([new Uint8Array(v)],{type:"application/octet-stream"}),b=URL.createObjectURL(f),y=document.createElement("a");y.href=b,y.download=`${o.replace(/[^a-zA-Z0-9]/g,"-")}-${Date.now()}.pmtpk`,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(b),c(`Exported "${o}" (${i.length} prompts)${p?" (encrypted)":""}`);return}if(r.id==="pp-import-btn"){const a=document.getElementById("pp-import-input");a&&a.click();return}if(r.id==="pp-undo-btn"){await Zt();return}if(r.id==="pp-login-btn"||r.dataset.loginLink==="true"){if(e.preventDefault(),e.stopPropagation(),!await It()){c("Login failed. Please try again.");return}w=await Q(),await g(!0),w.isAuthenticated&&(K(),V(w));return}if(r.id==="pp-logout-btn"){e.preventDefault(),e.stopPropagation(),await Ot(),await chrome.storage.local.remove(G),w=await Q(),await g(!0);return}if(r.id==="pp-dashboard-btn"){await chrome.tabs.create({url:Lt});return}if(r.dataset.save){e.preventDefault(),e.stopPropagation();const a=r.dataset.save,o=(await A()).filter(s=>s.source===a&&!s.packName);if(o.length===0){c("No prompts to save");return}if(!w.isAuthenticated||!w.user?.id){c("Not authenticated");return}try{c(`Saving ${o.length} prompt${o.length!==1?"s":""} to dashboard...`);const s={version:M,source:a,exportedAt:new Date().toISOString(),prompts:o.map(f=>({text:f.text,url:f.url,createdAt:f.createdAt,...f.header&&{header:f.header}}))},i={};o.forEach((f,b)=>{f.header&&(i[b.toString()]=f.header)});const p=JSON.stringify(s),m=await B(p),u=btoa(String.fromCharCode(...m)),v=await Ut.savePromptsToDashboard({source:a,fileData:u,promptCount:o.length,clerkId:w.user.id,headers:Object.keys(i).length>0?i:void 0});v.success?c("Saved to dashboard!"):c(v.error||"Failed to save")}catch{c("Failed to save to dashboard")}return}if(r.dataset.savePack){e.preventDefault(),e.stopPropagation();const a=r.dataset.savePack,[d,o]=a.split(":"),i=(await A()).filter(p=>p.packName===o&&p.source===d);if(i.length===0){c("No prompts to save");return}try{const p=prompt(`Add a password to encrypt (letters/numbers only, max ${T} chars, or leave empty):`);if(p===null)return;if(p&&!F(p)){c(`Password must be 1-${T} characters, letters and numbers only`);return}c(`Saving "${o}" pack (${i.length} prompts) to dashboard...`);const m={version:M,source:d,title:o,exportedAt:new Date().toISOString(),prompts:i.map(k=>({text:k.text,url:k.url,createdAt:k.createdAt}))},u=JSON.stringify(m),v=!!p;let f;v?f=await W(u,p):f=await B(u);const b=btoa(String.fromCharCode(...f));if(!w.user?.id){c("Not logged in. Please log in first.");return}if(!(await fetch(_t,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({title:o,fileData:b,promptCount:i.length,version:"1.0",price:0,isPublic:!1,isEncrypted:v})})).ok)throw new Error("Failed to save pack");c(`"${o}" saved to dashboard!`)}catch{c("Failed to save pack to dashboard")}return}}}),t.addEventListener("input",e=>{const n=e.target;if(n.id==="pp-search"&&n instanceof HTMLInputElement){const a=n.value,d=n.selectionStart;J&&clearTimeout(J),J=setTimeout(async()=>{j=a,await g();const o=document.getElementById("pp-search");o&&(o.focus(),o.setSelectionRange(d,d))},150);return}if(!(n instanceof HTMLTextAreaElement))return;const r=n.dataset.editInput;!r||L!==r||(R=n.value)}),t.addEventListener("change",async e=>{const n=e.target;if(n.id!=="pp-import-input")return;const r=n,a=r.files?.[0];a&&(await te(a),r.value="")}))}async function g(t=!1){await vt(),ne(),Xt();const e=document.getElementById("app");if(!e)throw new Error("Missing #app in popup index.html");if(Z){e.innerHTML=`
      <div class="pp-wrap pp-loading">
        <div class="pp-loading-content">
          <div class="pp-loading-spinner"></div>
          <div class="pp-loading-text">Loading...</div>
        </div>
      </div>
    `;return}const n=w.isAuthenticated,r=w.billing?.isPro??!1;let a;if(O&&!t?a=O:(a=await A(),O=a),await Wt()===!0&&!r&&n){const l=a.filter(E=>E.packName);if(l.length>0){const E=l.map(Y=>Y.id);(await pt(E)).ok&&(x(),a=await A(),O=a)}}n&&await Jt(r);const o=a.filter(l=>!(!r&&l.packName||!r&&st(l.source))),s=Qt(o,j),p=ee(s).filter(l=>r||!st(l.source)),m=await se();m?document.documentElement.dataset.activeSource=m:delete document.documentElement.dataset.activeSource;const u="",v=n?`<button class="pp-icon-btn pp-logged-in" id="pp-dashboard-btn" title="Logged in - Go to Dashboard">${$.user}</button>`:`<button class="pp-icon-btn" id="pp-login-btn" title="Login">${$.user}</button>`,b=new Set(a.filter(l=>l.packName).map(l=>`${l.source}:${l.packName}`)).size,k=r&&b<U?`<button class="pp-icon-btn" id="pp-import-btn" title="Import .pmtpk (${b}/${U})">${$.import}</button>`:r?`<button class="pp-icon-btn" id="pp-import-btn-disabled" title="Pack limit reached (${b}/${U})" disabled style="opacity: 0.4; cursor: not-allowed;">${$.import}</button>`:"";e.innerHTML=`
    <div class="pp-wrap">
      <div class="pp-header">
        <div class="pp-title">
          <img class="pp-logo" src="img/icon-48.png" alt="PromptPack" />
          PromptPack${u}
        </div>
        <div class="pp-header-actions">
          ${k}
          <button class="pp-icon-btn" id="pp-undo-btn" title="Undo">${$.undo}</button>
          ${v}
        </div>
      </div>
      <input type="file" id="pp-import-input" accept=".pmtpk" style="display:none">
      <div class="pp-sub">${n?`Logged in as ${w.user?.email??"Unknown"} <button class="pp-auth-link" id="pp-logout-btn" type="button">Sign out</button>`:'Powered by PmtPk.ai.<button class="pp-auth-link pp-signin-link" type="button" data-login-link="true">Sign in</button> for AI generated headers.'}</div>
      <input type="text" class="pp-search" id="pp-search" placeholder="Search prompts..." value="${h(j)}" />

      ${p.map(l=>{const E=j.trim()&&l.prompts.length>0,Y=m&&l.source===m&&l.type==="source"||E?"open":"",H=l.type==="pack",wt=H?n?`<button class="pp-icon-btn" data-save-pack="${h(l.key)}" title="Save ${h(l.displayName)} pack to dashboard">${$.save}</button>`:`<button class="pp-icon-btn" data-export-pack="${h(l.key)}" title="Export ${h(l.displayName)}">${$.export}</button>`:n?`<button class="pp-icon-btn" data-save="${l.source}" title="Save ${l.displayName} prompts to dashboard">${$.save}</button>`:`<button class="pp-icon-btn" data-export="${l.source}" title="Export ${l.displayName} prompts">${$.export}</button>`,yt=H?`<button class="pp-icon-btn" data-delete-pack="${h(l.key)}" title="Delete ${h(l.displayName)} pack">${$.delete}</button>`:`<button class="pp-icon-btn" data-delete-folder="${l.source}" title="Delete all ${l.displayName} prompts">${$.delete}</button>`;return`
            <details class="pp-sec ${H?"pp-pack":""}" ${Y} data-source="${l.source}" data-group-key="${h(l.key)}">
              <summary>
                <div class="pp-sum-left">
                  <span class="pp-arrow">${$.chevron}</span>
                  <span>${h(l.displayName)}${H?" ðŸ“¦":""}</span>
                </div>
                <div class="pp-actions">
                  ${wt}
                  ${yt}
                  <span class="pp-count">${l.prompts.length}</span>
                </div>
              </summary>
              <div class="pp-list">
                ${l.prompts.length?l.prompts.map(oe).join(""):`<div class="pp-empty">No prompts in ${h(l.displayName)} yet.</div>`}
              </div>
            </details>
          `}).join("")}
    </div>
  `,ie()}(async()=>{const t=await Rt();t?(w=t,Z=!1,await g(),w.isAuthenticated&&(K(),V(w)),Ct(w).then(async e=>{e&&(w=e,await g(),w.isAuthenticated&&(K(),V(w)))})):(await g(),w=await Q(),Z=!1,await g(),w.isAuthenticated&&(K(),V(w)))})();
