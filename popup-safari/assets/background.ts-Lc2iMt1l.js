import{g as o,d as m,F as P,A as _}from"./api-lEPXQ6QH.js";import{g as n,c as I,i as T}from"./auth-BzzJO1E-.js";chrome.runtime.onMessage.addListener((u,y,t)=>{const r=u;if(!(!r||typeof r!="object")&&!(r.type!=="PP_CLASSIFY"&&r.type!=="PP_VERIFY_AUTH"&&r.type!=="PP_GET_ENHANCE_TOKEN"&&r.type!=="PP_GET_PROMPT_LIMIT"))return(async()=>{if(r.type==="PP_GET_ENHANCE_TOKEN"){const e=await o();if(!e?.userId||!e.accessToken||e.expiresAt<Date.now()){t({token:null});return}const s=btoa(JSON.stringify({userId:e.userId}));t({token:s});return}if(r.type==="PP_GET_PROMPT_LIMIT"){const e=await o();if(e?.entitlements?.promptLimit){t({limit:e.entitlements.promptLimit});return}if(e?.tier==="paid"){t({limit:m});return}t({limit:P});return}if(r.type==="PP_VERIFY_AUTH"){if((await n())?.isAuthenticated){t({ok:!0});return}const s=await o();if(s?.userId&&s.expiresAt>Date.now()){t({ok:!0});return}t({ok:!1,error:"Sign in required"});return}const a=await o();if(!a?.userId){t({ok:!1,error:"Sign in required for AI-generated headers"});return}const c=await n()??{isAuthenticated:!0,user:{id:a.userId},billing:{isPro:!1,plan:"free"},classifyLimit:50},{allowed:f,limit:l}=await I(c);if(!f){t({ok:!1,error:`Daily AI header limit reached (${l}/day). Upgrade for more.`,status:429});return}const i=await fetch(`${_}/classify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({promptText:r.promptText.slice(0,500),maxWords:r.maxWords??2,userId:a.userId})});if(!i.ok){const e=await i.json().catch(()=>({error:i.statusText}));t({ok:!1,error:e.error||"Failed to classify",status:i.status});return}await T();const d=await i.json();t({ok:!0,header:d.header})})().catch(a=>{t({ok:!1,error:a instanceof Error?a.message:"Classification failed"})}),!0});
