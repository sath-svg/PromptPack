import{b,g as T,h as S,j as Y,S as H}from"./api-lEPXQ6QH.js";const E=50,R=500,L="pp_classify_usage",w="pp_auth_return_tab",P="pp_auth_cache",A="pp_auth_state_cache",F=1440*60*1e3;function M(t){return!t||!t.accessToken?!1:t.expiresAt>Date.now()}async function p(){try{await chrome.storage.session.remove(P)}catch{}try{await chrome.storage.local.remove(P)}catch{}}async function D(){try{const e=(await chrome.storage.local.get(A))[A];if(e&&e.state&&typeof e.cachedAt=="number")return e}catch{}return null}async function _(t){try{const e={state:t,cachedAt:Date.now()};await chrome.storage.local.set({[A]:e})}catch{}}async function G(){try{await chrome.storage.local.remove(A)}catch{}}function x(t){return Date.now()-t.cachedAt<F}function I(){return new Date().toISOString().split("T")[0]}async function B(){try{const e=(await chrome.storage.local.get(L))[L],a=I();return e&&e.date===a?e:{count:0,date:a}}catch{return{count:0,date:I()}}}async function j(){const t=await B(),e=t.count+1;try{await chrome.storage.local.set({[L]:{count:e,date:t.date}})}catch{}return e}async function q(t){if(!t.isAuthenticated)return{allowed:!1,remaining:0,limit:0};const e=t.classifyLimit??(t.billing?.isPro?R:E),a=await B(),c=Math.max(0,e-a.count);return{allowed:a.count<e,remaining:c,limit:e}}function k(t){return t?R:E}async function U(t){try{const e=await b.getBillingStatus(t);return{isPro:e.hasPro,plan:e.tier}}catch{return null}}async function z(){const t=await D();return t&&x(t)?t.state:null}async function N(){await p();const t=await D();if(t&&x(t))return t.state;const e=await C();return await _(e),e}async function C(){const t=await T();if(!t)return{isAuthenticated:!1};if(!M(t)){if(t.refreshToken){if(t.refreshToken.includes(".")||t.refreshToken.length>100)return await S(),await p(),{isAuthenticated:!1};if(await b.refreshToken()){const r=await T();if(r&&r.expiresAt>Date.now()){const n=await U(r.userId),i=n?.isPro??!1;return{isAuthenticated:!0,user:{id:r.userId,email:r.email,tier:r.tier},entitlements:r.entitlements,billing:n||void 0,classifyLimit:k(i)}}}}return await S(),await p(),{isAuthenticated:!1}}const e=await U(t.userId),a=e?.isPro??!1;return{isAuthenticated:!0,user:{id:t.userId,email:t.email,tier:t.tier},entitlements:t.entitlements,billing:e||void 0,classifyLimit:k(a)}}async function V(t){try{if(t.isAuthenticated&&t.user?.id){const c=await U(t.user.id);if(c){if(c.isPro!==t.billing?.isPro){const r={...t,billing:c,classifyLimit:c.isPro?500:50};return await _(r),r}await _(t)}return null}const e=await C(),a=e.isAuthenticated!==t.isAuthenticated||e.user?.id!==t.user?.id||e.billing?.isPro!==t.billing?.isPro;return await _(e),a?e:null}catch{return null}}async function W(){const t=crypto.randomUUID();try{const n=await chrome.storage.local.get("pp_auth_states"),i=Array.isArray(n.pp_auth_states)?n.pp_auth_states:[],d=Date.now(),u=i.map(o=>{if(typeof o=="string")return{value:o,createdAt:d};if(o&&typeof o=="object"){const m=o;if(m.value)return{value:m.value,createdAt:typeof m.createdAt=="number"?m.createdAt:d}}return null}).filter(Boolean),f=[{value:t,createdAt:d},...u].filter(o=>d-o.createdAt<600*1e3).slice(0,5);await chrome.storage.local.set({pp_auth_state:t,pp_auth_states:f})}catch{await chrome.storage.local.set({pp_auth_state:t})}try{const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});n?.id?await chrome.storage.local.set({[w]:{id:n.id,windowId:n.windowId}}):await chrome.storage.local.remove(w)}catch{}const e=chrome.runtime.getURL("auth-callback.html"),a=new URL(e);a.hash=`state=${t}`;const c=a.toString(),l=new URL(Y);l.searchParams.set("state",t),l.searchParams.set("redirect_uri",c),l.searchParams.set("client_id","promptpack-extension");const r=new URLSearchParams({state:t,redirect_uri:c,client_id:"promptpack-extension"});l.hash=r.toString();try{const n=await chrome.tabs.create({url:l.toString(),active:!0});if(!n.id)return!1;const i=n.id;return new Promise(d=>{const u=async(f,o,m)=>{if(f===i&&o.url&&o.url.startsWith(e)){chrome.tabs.onUpdated.removeListener(u);try{const y=new URL(o.url),s=new URLSearchParams(y.search);if(y.hash){const v=new URLSearchParams(y.hash.replace(/^#/,""));if(!s.get("state")){const h=v.get("state");h&&s.set("state",h)}if(!s.get("code")){const h=v.get("code");h&&s.set("code",h)}}const g=await K(s);if(g){try{const h=(await chrome.storage.local.get(w))[w];await chrome.storage.local.remove(w),h?.id&&(await chrome.tabs.update(h.id,{active:!0}),typeof h.windowId=="number"&&await chrome.windows.update(h.windowId,{focused:!0}))}catch{}await chrome.tabs.remove(i)}else await chrome.tabs.remove(i);d(g)}catch{await chrome.tabs.remove(i),d(!1)}}};chrome.tabs.onUpdated.addListener(u),chrome.tabs.onRemoved.addListener(f=>{f===i&&(chrome.tabs.onUpdated.removeListener(u),chrome.storage.local.remove(w).catch(()=>{}),d(!1))})})}catch{try{await chrome.storage.local.remove(w)}catch{}return!1}}async function K(t){const e=t.get("code"),a=t.get("state"),c=t.get("error");if(c)return console.error("Auth callback error:",c),!1;if(!e||!a)return console.error("Missing required parameters in callback:",{hasCode:!!e,hasState:!!a}),!1;const l=await chrome.storage.local.get(["pp_auth_state","pp_auth_states"]),r=l.pp_auth_state,n=l.pp_auth_states,i=Date.now(),u=(Array.isArray(n)?n.map(s=>{if(typeof s=="string")return{value:s,createdAt:i};if(s&&typeof s=="object"){const g=s;if(g.value)return{value:g.value,createdAt:typeof g.createdAt=="number"?g.createdAt:i}}return null}).filter(Boolean):[]).filter(s=>i-s.createdAt<600*1e3),f=r===a,o=u.some(s=>s.value===a),m=!!r||u.length>0;if(!f&&!o)if(!m)console.warn("Auth state missing in storage; proceeding with callback",{state:a});else return console.error("Auth state mismatch:",{state:a,hasDirect:!!r,listSize:u.length}),!1;const y=u.filter(s=>s.value!==a);await chrome.storage.local.remove("pp_auth_state"),await chrome.storage.local.set({pp_auth_states:y});try{await b.exchangeCodeForToken(e),await p();const s=await C();return await _(s),s.isAuthenticated===!0}catch(s){return console.error("Auth callback exchange failed:",s),await p(),!1}}async function X(){await b.logout(),await S(),await p(),await G();try{const t=await chrome.tabs.create({url:H,active:!1});if(t.id){const e=t.id,a=(c,l)=>{c===e&&l.status==="complete"&&(chrome.tabs.onUpdated.removeListener(a),setTimeout(()=>{chrome.tabs.remove(e).catch(()=>{})},1500))};chrome.tabs.onUpdated.addListener(a),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(a),chrome.tabs.remove(e).catch(()=>{})},1e4)}}catch{}}export{N as a,X as b,q as c,z as g,K as h,j as i,W as l,V as v};
